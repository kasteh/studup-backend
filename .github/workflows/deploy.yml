name: DÃ©ploiement Automatique Studup

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v3

      - name: DÃ©ploiement sur le serveur
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ DÃ‰BUT DU DÃ‰PLOIEMENT"
            echo "=========================================="
            
            # Ã‰tape 1: Aller dans /var/www
            cd /var/www
            echo "ğŸ“ Dossier: /var/www"
            
            # Ã‰tape 2: VÃ©rifier et corriger les permissions pour suppression
            echo "ğŸ”§ VÃ©rification des permissions..."
            if [ -d studup-backend ]; then
                echo "ğŸ—‘ï¸  Nettoyage de l'ancienne version..."
                sudo chown -R ubuntu:ubuntu studup-backend
                sudo chmod -R 755 studup-backend
                sudo rm -rf studup-backend
                echo "âœ… Ancien dossier supprimÃ©"
            fi
            
            # Ã‰tape 3: Cloner le nouveau code
            echo "ğŸ“¦ Clonage du dÃ©pÃ´t..."
            git clone https://github.com/kasteh/studup-backend.git
            cd studup-backend
            echo "âœ… Dossier clonÃ©: /var/www/studup-backend"
            
            # Ã‰tape 4: VÃ©rifier que deploy.sh existe et est Ã  jour
            if [ ! -f deploy.sh ]; then
                echo "âŒ deploy.sh introuvable, arrÃªt du dÃ©ploiement"
                exit 1
            fi
            
            # Ã‰tape 5: Rendre le script exÃ©cutable et l'exÃ©cuter
            chmod +x deploy.sh
            echo "â–¶ï¸  ExÃ©cution du script de dÃ©ploiement..."
            ./deploy.sh
            
            # Ã‰tape 6: RedÃ©marrage d'Apache
            echo "ğŸ”„ RedÃ©marrage d'Apache..."
            sudo systemctl restart apache2
            
            # Ã‰tape 7: VÃ©rification finale
            echo "ğŸ“‹ VÃ©rification de l'application..."
            sleep 5
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost)
            
            if [ "$HTTP_STATUS" = "200" ]; then
                echo "ğŸ‰ SUCCÃˆS: Application fonctionnelle (HTTP $HTTP_STATUS)"
            else
                echo "âš ï¸  ATTENTION: HTTP $HTTP_STATUS"
                echo "ğŸ“‹ Logs Apache: sudo tail -n 20 /var/log/apache2/error.log"
            fi
            
            echo "=========================================="
            echo "âœ… DÃ‰PLOIEMENT TERMINÃ‰"
            echo "ğŸŒ URL: https://vps-d91fd27c.vps.ovh.net"