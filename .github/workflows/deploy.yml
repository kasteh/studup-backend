name: DÃ©ploiement Simple et Fiable

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: DÃ©ploiement sur le serveur
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 15m
          script: |
            set -e
            echo "ğŸš€ DÃ‰BUT DU DÃ‰PLOIEMENT ULTRA-SIMPLIFIÃ‰"
            echo "=========================================="
            
            # Ã‰tape 1: Aller dans /var/www
            cd /var/www
            echo "ğŸ“ Dossier: /var/www"
            
            # Ã‰tape 2: Sauvegarde rapide
            BACKUP_DIR="/tmp/studup-backup-$(date +%s)"
            if [ -d studup-backend ]; then
                echo "ğŸ’¾ Sauvegarde rapide..."
                mkdir -p "$BACKUP_DIR"
                cp -r studup-backend/storage/app/public "$BACKUP_DIR/" 2>/dev/null || true
                cp studup-backend/.env "$BACKUP_DIR/" 2>/dev/null || true
                echo "âœ… Sauvegarde effectuÃ©e"
            fi
            
            # Ã‰tape 3: Nettoyage complet
            echo "ğŸ§¹ Nettoyage complet..."
            sudo rm -rf studup-backend
            echo "âœ… Ancien dossier supprimÃ©"
            
            # Ã‰tape 4: Nouveau clonage
            echo "ğŸ“¦ Clonage du nouveau code..."
            git clone https://github.com/kasteh/studup-backend.git
            cd studup-backend
            echo "âœ… Code clonÃ©"
            
            # Ã‰tape 5: Configuration basique
            echo "ğŸ”§ Configuration basique..."
            
            # Restaurer .env ou crÃ©er depuis exemple
            if [ -f "$BACKUP_DIR/.env" ]; then
                cp "$BACKUP_DIR/.env" .env
                echo "âœ… .env restaurÃ© depuis sauvegarde"
            elif [ ! -f .env ] && [ -f .env.example ]; then
                cp .env.example .env
                echo "âœ… .env crÃ©Ã© depuis .env.example"
            fi
            
            # VÃ©rifier et gÃ©nÃ©rer APP_KEY si nÃ©cessaire
            if ! grep -q "APP_KEY=base64:" .env; then
                echo "ğŸ”‘ GÃ©nÃ©ration de la clÃ© APP_KEY..."
                NEW_KEY=$(php -r "echo 'base64:'.base64_encode(random_bytes(32));")
                sed -i "s/APP_KEY=.*/APP_KEY=$NEW_KEY/" .env
                echo "âœ… ClÃ© APP_KEY gÃ©nÃ©rÃ©e"
            fi
            
            # Ã‰tape 6: Installation Composer SANS scripts
            echo "ğŸ“¦ Installation Composer (sans scripts)..."
            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev --no-scripts
            echo "âœ… DÃ©pendances installÃ©es"
            
            # Ã‰tape 7: Structure des dossiers
            echo "ğŸ“ CrÃ©ation des dossiers..."
            mkdir -p storage/app/public
            mkdir -p storage/framework/sessions
            mkdir -p storage/framework/views
            mkdir -p storage/framework/cache/data
            mkdir -p storage/logs
            mkdir -p bootstrap/cache
            echo "âœ… Dossiers crÃ©Ã©s"
            
            # Ã‰tape 8: Permissions Apache
            echo "ğŸ” Configuration des permissions..."
            sudo chown -R www-data:www-data /var/www/studup-backend
            sudo chmod -R 755 /var/www/studup-backend
            sudo chmod -R 775 storage bootstrap/cache
            sudo chmod -R 777 storage/framework/cache storage/logs
            
            # CrÃ©er les fichiers essentiels
            sudo -u www-data touch storage/logs/laravel.log
            sudo -u www-data touch bootstrap/cache/config.php
            sudo chmod 666 storage/logs/laravel.log bootstrap/cache/config.php
            echo "âœ… Permissions configurÃ©es"
            
            # Ã‰tape 9: Restauration des uploads
            echo "ğŸ“ Restauration des fichiers uploadÃ©s..."
            if [ -d "$BACKUP_DIR/public" ]; then
                cp -r "$BACKUP_DIR/public"/* storage/app/public/ 2>/dev/null || true
                echo "âœ… Fichiers uploadÃ©s restaurÃ©s"
            fi
            
            # Ã‰tape 10: Lien de stockage
            echo "ğŸ”— CrÃ©ation du lien de stockage..."
            if [ -L "public/storage" ]; then
                rm public/storage
            fi
            ln -sf ../storage/app/public public/storage
            echo "âœ… Lien de stockage crÃ©Ã©"
            
            # Ã‰tape 11: Test Laravel basique
            echo "ğŸ” Test de fonctionnement Laravel..."
            if php -r "require 'vendor/autoload.php'; echo 'âœ… Autoloader fonctionnel';"; then
                echo "âœ… Laravel peut charger l'autoloader"
            else
                echo "âŒ ERREUR: ProblÃ¨me avec l'autoloader"
                echo "ğŸ“‹ Tentative de rÃ©paration..."
                composer dump-autoload
            fi
            
            # Ã‰tape 12: Nettoyage
            echo "ğŸ§¹ Nettoyage final..."
            rm -rf "$BACKUP_DIR"
            
            # Ã‰tape 13: RedÃ©marrage Apache
            echo "ğŸ”„ RedÃ©marrage d'Apache..."
            sudo systemctl restart apache2
            
            # Ã‰tape 14: Test final
            echo "ğŸ“‹ Test final de l'application..."
            sleep 3
            if curl -s -f http://localhost >/dev/null 2>&1; then
                echo "ğŸ‰ DÃ‰PLOIEMENT RÃ‰USSI !"
                echo "ğŸŒ Application accessible sur: https://vps-d91fd27c.vps.ovh.net"
            else
                echo "âš ï¸  L'application ne rÃ©pond pas immÃ©diatement"
                echo "ğŸ’¡ Elle peut mettre quelques minutes Ã  se initialiser"
                echo "ğŸ“‹ VÃ©rifiez avec: sudo tail -f /var/log/apache2/error.log"
            fi
            
            echo "=========================================="