name: DÃ©ploiement Simple (Sans Tests)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: DÃ©ploiement direct sur le serveur
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10m
          script: |
            set -e
            
            echo "ğŸš€ DÃ‰BUT DU DÃ‰PLOIEMENT DIRECT"
            echo "=========================================="
            
            cd /var/www
            
            # Backup et nettoyage
            if [ -d studup-backend ]; then
                echo "ğŸ’¾ Backup de l'ancienne version..."
                sudo cp -r studup-backend studup-backend-backup-$(date +%s) 2>/dev/null || true
                
                echo "ğŸ”„ Mise Ã  jour du code..."
                cd studup-backend
                sudo chown -R ubuntu:ubuntu .
                git fetch origin main
                git reset --hard origin/main
            else
                echo "ğŸ“¦ Premier clonage..."
                git clone https://github.com/kasteh/studup-backend.git
                cd studup-backend
            fi
            
            # ExÃ©cution du script de dÃ©ploiement
            if [ -f deploy.sh ]; then
                chmod +x deploy.sh
                echo "â–¶ï¸  ExÃ©cution du script de dÃ©ploiement..."
                ./deploy.sh
            else
                echo "âŒ deploy.sh introuvable !"
                exit 1
            fi
            
            # RedÃ©marrage Apache
            echo "ğŸ”„ RedÃ©marrage d'Apache..."
            sudo systemctl restart apache2
            
            # Test rapide
            sleep 5
            if curl -s -f http://localhost >/dev/null 2>&1; then
                echo "ğŸ‰ DÃ‰PLOIEMENT RÃ‰USSI !"
                echo "ğŸŒ Application accessible sur: https://vps-d91fd27c.vps.ovh.net"
            else
                echo "âš ï¸  VÃ©rifiez les logs Apache si nÃ©cessaire"
            fi
            
            echo "=========================================="