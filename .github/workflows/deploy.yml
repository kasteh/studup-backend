name: DÃ©ploiement Fiable Studup

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: DÃ©ploiement sur le serveur
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 30m
          script: |
            set -e
            echo "ğŸš€ DÃ©ploiement Studup - DÃ©but"
            echo "=========================================="

            cd /var/www

            # Sauvegarde
            BACKUP_DIR="/tmp/studup-backup-$(date +%s)"
            if [ -d studup-backend ]; then
                echo "ğŸ’¾ Sauvegarde en cours..."
                mkdir -p "$BACKUP_DIR"
                cp -rf studup-backend/storage/app/public "$BACKUP_DIR/" 2>/dev/null || true
                cp -f studup-backend/.env "$BACKUP_DIR/" 2>/dev/null || true
                echo "âœ… Sauvegarde effectuÃ©e"
            fi

            # Nettoyage
            echo "ğŸ§¹ Nettoyage du dossier existant..."
            sudo rm -rf studup-backend
            echo "âœ… Ancien dossier supprimÃ©"

            # Clonage
            echo "ğŸ“¦ Clonage du dÃ©pÃ´t..."
            git clone https://github.com/kasteh/studup-backend.git
            cd studup-backend
            echo "âœ… Code clonÃ©"

            # Configuration .env
            echo "ğŸ”§ Configuration de l'environnement..."
            if [ -f "$BACKUP_DIR/.env" ]; then
                sudo cp "$BACKUP_DIR/.env" .env
                echo "âœ… .env restaurÃ©"
            elif [ -f .env.example ]; then
                sudo cp .env.example .env
                echo "âœ… .env crÃ©Ã© depuis .env.example"
            else
                echo "âŒ ERREUR: Aucun fichier .env trouvÃ©"
                exit 1
            fi

            # ClÃ© APP_KEY
            if ! grep -q "APP_KEY=base64:" .env; then
                echo "ğŸ”‘ GÃ©nÃ©ration de la clÃ© APP_KEY..."
                NEW_KEY=$(php -r "echo 'base64:'.base64_encode(random_bytes(32));")
                sudo sed -i "s/APP_KEY=.*/APP_KEY=$NEW_KEY/" .env
                echo "âœ… ClÃ© APP_KEY gÃ©nÃ©rÃ©e"
            fi

            # CrÃ©ation des dossiers nÃ©cessaires
            echo "ğŸ“ CrÃ©ation des dossiers..."
            sudo mkdir -p storage/app/public storage/framework/sessions storage/framework/views storage/framework/cache/data storage/logs bootstrap/cache storage/api-docs database/migrations
            sudo chown -R www-data:www-data storage bootstrap/cache database/migrations
            sudo chmod -R 775 storage bootstrap/cache database/migrations storage/api-docs
            echo "âœ… Dossiers crÃ©Ã©s et permissions appliquÃ©es"

            # Installation des dÃ©pendances Composer
            echo "ğŸ“¦ Installation Composer..."
            sudo -u www-data composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
            echo "âœ… DÃ©pendances installÃ©es"

            # Lien de stockage
            echo "ğŸ”— CrÃ©ation du lien de stockage..."
            if [ -L "public/storage" ]; then
                sudo rm -f public/storage
            fi
            sudo ln -sf ../storage/app/public public/storage
            sudo chown -h www-data:www-data public/storage 2>/dev/null || true
            echo "âœ… Lien de stockage crÃ©Ã©"

            # Publier et gÃ©nÃ©rer Swagger
            echo "ğŸ“„ Publication L5 Swagger..."
            sudo -u www-data php artisan vendor:publish --provider="L5Swagger\L5SwaggerServiceProvider" --force
            sudo -u www-data php artisan l5-swagger:generate
            echo "âœ… Documentation Swagger gÃ©nÃ©rÃ©e"

            # Publier Sanctum
            echo "ğŸ” Publication Sanctum..."
            sudo -u www-data php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider" --force
            echo "âœ… Sanctum publiÃ©"

            # RÃ©paration spÃ©cifique erreur 500 et cache
            echo "ğŸ”§ Nettoyage cache et configuration..."
            sudo -u www-data php artisan config:clear
            sudo -u www-data php artisan cache:clear
            sudo -u www-data php artisan route:clear
            sudo -u www-data php artisan view:clear
            sudo -u www-data composer dump-autoload --optimize
            echo "âœ… Cache et autoload OK"

            # Restauration fichiers uploadÃ©s
            echo "ğŸ“ Restauration fichiers uploadÃ©s..."
            if [ -d "$BACKUP_DIR/public" ]; then
                sudo cp -rf "$BACKUP_DIR/public"/* storage/app/public/ 2>/dev/null || true
                sudo chown -R www-data:www-data storage/app/public
                echo "âœ… Uploads restaurÃ©s"
            fi

            # RedÃ©marrage Apache
            echo "ğŸ”„ RedÃ©marrage Apache..."
            sudo systemctl restart apache2

            # Test final
            echo "ğŸ“‹ Test de l'application..."
            sleep 10
            for i in {1..5}; do
                if curl -s -f --connect-timeout 20 http://localhost >/dev/null 2>&1; then
                    echo "ğŸ‰ DÃ©ploiement rÃ©ussi !"
                    echo "ğŸŒ Application accessible sur: https://vps-d91fd27c.vps.ovh.net"
                    exit 0
                fi
                echo "â³ Tentative $i/5 - attente supplÃ©mentaire..."
                sleep 5
            done

            echo "âš ï¸ L'application peut avoir des problÃ¨mes de configuration. VÃ©rifiez les logs."
            echo "ğŸ’¡ sudo tail -f /var/www/studup-backend/storage/logs/laravel.log"
            echo "=========================================="
