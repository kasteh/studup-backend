name: Déploiement Simple (Sans Tests)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Déploiement direct sur le serveur
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10m
          script: |
            set -e
            
            echo "🚀 DÉBUT DU DÉPLOIEMENT DIRECT"
            echo "=========================================="
            
            cd /var/www
            
            # Backup et nettoyage
            if [ -d studup-backend ]; then
                echo "💾 Backup de l'ancienne version..."
                sudo cp -r studup-backend studup-backend-backup-$(date +%s) 2>/dev/null || true
                
                echo "🔄 Mise à jour du code..."
                cd studup-backend
                sudo chown -R ubuntu:ubuntu .
                git fetch origin main
                git reset --hard origin/main
            else
                echo "📦 Premier clonage..."
                git clone https://github.com/kasteh/studup-backend.git
                cd studup-backend
            fi
            
            # Exécution du script de déploiement
            if [ -f deploy.sh ]; then
                chmod +x deploy.sh
                echo "▶️  Exécution du script de déploiement..."
                ./deploy.sh
            else
                echo "❌ deploy.sh introuvable !"
                exit 1
            fi
            
            # Redémarrage Apache
            echo "🔄 Redémarrage d'Apache..."
            sudo systemctl restart apache2
            
            # Test rapide
            sleep 5
            if curl -s -f http://localhost >/dev/null 2>&1; then
                echo "🎉 DÉPLOIEMENT RÉUSSI !"
                echo "🌐 Application accessible sur: https://vps-d91fd27c.vps.ovh.net"
            else
                echo "⚠️  Vérifiez les logs Apache si nécessaire"
            fi
            
            echo "=========================================="